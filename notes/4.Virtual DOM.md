# Virtual DOM(虚拟DOM)

## 课程目标
- 了解什么是虚拟DOM，以及虚拟DOM的作用
- `Snabbdom`的基本使用
- `Snabbdom`的源码解析

## 什么是虚拟DOM
- `Virtual DOM(虚拟DOM)`是由普通的`JS对象`来描述的`DOM对象`，因为不是真实的DOM对象，所以叫做虚拟DOM

## 为什么要使用虚拟DOM
- 手动操作`DOM`比较麻烦，还需要考虑游览器兼容性问题，虽然由`jQuery`等库简化`DOM`操作，但是随着项目的复杂`DOM`操作复杂也随之提升
- 为了简化`DOM`的复杂操作于是出现了各种`MVVM`框架，`MVVM`框架解决了视图和状态的同步问题
- 为了简化视图的操作我们可以使用模版引擎，但是模版引擎没有解决跟踪状态变化的问题，于是`Virtual DOM`出现了
- `Virtual DOM`的好处是当状态改变时不需要立即更新`DOM`，只需要创建一个虚拟树来描述`DOM`，`Virtual DOM`内部将弄清楚如何有效`(diff)`的更新`DOM`
- 参考 github 上[Virtual DOM](https://github.com/Matt-Esch/virtual-dom)的描述
  - `虚拟DOM`可以维护程序的状态，跟踪上一次的状态
  - 通过比较前后两次状态的差异更新`真实DOM`

## 虚拟DOM的作用
- 维护视图和状态的关系
- 复杂视图情况下提升渲染性能
- 除了渲染`DOM`意外，还可以实现`SSR`(Nuxt.js/Next.js)、原生应用(Weex/React Native)、小程序(mpvue/uni-app)等

## Virtual DOM库
- [Snabbdom](https://github.com/snabbdom/snabbdom)
  - Vue 2.x内部使用的 Virtual DOM 就是改造的 Snabbdom
  - 大约 200 SLOC(single line of code)
  - 通过模块可扩展
  - 源码使用 TypeScript 开发
  - 最快的 Virtual DOM 之一
- [virtual-dom](https://github.com/Matt-Esch/virtual-dom)

## Snabbdom基本使用

### 导入 Snabbdom
#### Snabbdom文档
- 看文档的意义
  - 学习任何一个库都要先看文档
  - 通过文档了解库的作用
  - 看文档提供的示例，自己快速实现一个dome
  - 通过文档查看 API 的使用
- 文档地址
  - https://github.com/snabbdom/snabbdom
  - [中文翻译](https://github.com/coconilu/Blog/issues/152)
#### 导入 Snabbdom
- Snabbdom 的官网 demo 中导入使用的是 commonjs 模块化语法，我们使用更流行的 ES6 模块化的语法 import
- 关于模块化的语法请参考阮一峰老师的[Module的语法]
- ES6 模块与 CommonJS 模块的差异
```js
import { init, h, thunk } from 'snabbdom'
```
- Snabbdom 的核心仅提供最基本的功能，只导出了三个函数init()、h()、thunk()
  - init()是一个高阶函数，返回patch()
  - h()返回虚拟节点 VNode，这个函数我们在使用 Vue.js 的时候见过
  ```js
    new Vue({
      router,
      store,
      render: h => h(App)
    }).$mount('#app')
  ```
  - thunk()是一种优化策略，可以在处理不可变数据时使用

### 模块
Snabbdom 的核心库并不能处理元素的属性/样式/事件等，如果需要处理的化，可以使用模块

#### 常用模块
- 官方提供了6个模块
  - attributes
    - 设置 DOM 元素的属性，使用 setAttribute()
    - 处理布尔类型的属性
  - props
    - 和 attributes 模块相似，设置 DOM 元素的属性 element[attr] = value
    - 不处理布尔类型的属性
  - class
    - 切换类样式
    - 注意：给元素设置样式是通过 sel 选择器
  - dataset
    - 设置 data-* 的自定义属性
  - eventlisteners
    - 注册和移除事件
  - style
    - 设置行内样式，支持动画
    - delayed/remove/destroy
#### 模块使用
- 模块使用步骤
  - 导入需要的模块
  - init() 中注册模块
  - 使用 h() 函数创建 VNode 的时候，可以把第二个参数设置为对象，其他参数往后移

## Snabbdom 源码解析

### 概述

#### 如何学习源码
- 先宏观了解
- 带着目标看源码
- 看源码的过程要不求甚解
- 调试
- 参考资料

#### Snabbdom 的核心
- 使用 h() 函数创建 JavaScript 对象(VNode)描述真实 DOM
- init() 设置模块，创建 patch()
- patch() 比较新旧两个 VNode
- 把变化的内容更新到真实 DOM 树上

#### Snabbdom 源码
- 源码地址：
  - https://github.com/snabbdom/snabbdom

#### h 函数
- 介绍
  - 在使用 Vue 的时候见过 h() 函数
  ```js
  new Vue({
    router,
    story,
    render: h => h(App)
  }).$mount('#app')
  ```
  - h() 函数最早见于 hyperscript，使用 JavaScript 创建超文本
  - Snabbdom 中的 h() 函数不是用来创建超文本，而是创建 VNode
- 函数重载
  - 概念
    - **参数个数**或**类型**不同的函数
    - JavaScript 中没有重载的概念
    - TypeScript 中有重载，不过重载的实现还是通过代码调整参数
    - 重载的示意
    ```js
    function add(a, b) {
      console.log(a + b)
    }
    function add(a,b, c) {
      console.log(a + b +c)
    }
    add(1, 2)
    add(1, 2, 3)
    ```
  - 源码位置：src/h.ts